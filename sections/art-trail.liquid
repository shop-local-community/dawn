{% comment %}
  Coulsdon Art Trail Interactive Map Section using Apple Maps with MapKit JS and Annotation Clustering
  Dynamically pulling locations from Metaobjects
{% endcomment %}

{% assign finial_definition = shop.metaobject_definitions.finial.values %}
{% assign mapkit_js_token = section.settings.mapkit_js_token %}

<script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js" async></script>

<div class="coulsdon-art-trail">
  <div id="map-container" style="width: 100%; height: 480px;"></div>

  <script type="text/javascript">
    document.addEventListener(
      'DOMContentLoaded',
      function () {
        if (typeof mapkit !== 'undefined') {
          initializeMap();
        } else {
          document
            .querySelector('script[src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js"]')
            .addEventListener('load', initializeMap, { passive: true });
        }
      },
      { passive: true }
    );

    function initializeMap() {
      mapkit.init({
        authorizationCallback: function (done) {
          done('{{ mapkit_js_token }}');
        },
      });

      var map = new mapkit.Map('map-container', {
        center: new mapkit.Coordinate(51.320219, -0.138661), // Center on Coulsdon
        region: new mapkit.CoordinateRegion(
          new mapkit.Coordinate(51.320219, -0.138661),
          new mapkit.CoordinateSpan(0.02, 0.02) // Adjust the zoom level
        ),
        showsCompass: mapkit.FeatureVisibility.Hidden,
        showsZoomControl: true,
      });

      // Debugging line to check the value of locations
      console.log('Metaobjects locations:', {{ finial_definition | json }});

      // Manually construct the locations array in JavaScript
      var locations = [
        {% for location in finial_definition %}
        {
          "fields": {
            "latitude": { "value": {{ location.fields.latitude.value }} },
            "longitude": { "value": {{ location.fields.longitude.value }} },
            "title": { "value": "{{ location.fields.title.value }}" },
            "description": { "value": "{{ location.fields.description.value }}" }
          }
        }{% if forloop.last == false %},{% endif %}
        {% endfor %}
      ];

      console.log('Locations array:', locations); // Debugging line

      if (locations.length > 0) {
        // Adding annotations to the map using mapkit.Annotation
        var annotations = locations.map(function (location) {
          return new mapkit.Annotation(
            new mapkit.Coordinate(location.fields.latitude.value, location.fields.longitude.value),
            {
              title: location.fields.title.value,
              subtitle: location.fields.description.value,
              callout: new mapkit.CalloutElement({
                title: location.fields.title.value,
                subtitle: location.fields.description.value,
              }),
            }
          );
        });

        // Batch adding annotations to the map
        requestAnimationFrame(function () {
          map.addAnnotations(annotations);
        });

        // Enable clustering
        map.annotationsForCluster = function (annotations) {
          return annotations.length > 1; // Enable clustering when there are more than one annotation in the same area
        };
      } else {
        console.log('No locations available to display on the map.');
      }
    }
  </script>
</div>

<style>
  #map-container {
    /* Custom styles can be added here */
  }
</style>

{% schema %}
{
  "name": "Art Trail",
  "settings": [
    {
      "type": "text",
      "id": "mapkit_js_token",
      "label": "MapKit JS Token",
      "default": "YOUR_MAPKIT_JS_TOKEN_HERE",
      "info": "Enter your MapKit JS token. You can get it from your Apple Developer account."
    }
  ],
  "presets": [
    {
      "name": "Art Trail",
      "category": "Art Trail"
    }
  ]
}
{% endschema %}
