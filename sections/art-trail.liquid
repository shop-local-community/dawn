{% comment %}
  Coulsdon Art Trail Interactive Map Section using Apple Maps with MapKit JS and Annotation Clustering
  Dynamically pulling locations from Metaobjects
{% endcomment %}

{% assign finial_definition = shop.metaobjects.finial.values %}
{% assign mapkit_js_token = section.settings.mapkit_js_token %}
{% assign map_tint_color = section.settings.map_tint_color %}
{% assign color_scheme = section.settings.color_scheme %}
{% assign poi_filter = section.settings.poi_filter | split: ',' %}

<script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js" async></script>

<div class="coulsdon-art-trail">
  <div id="map-container" style="width: 100%; height: 480px;"></div>

  <script type="text/javascript">
    function initializeMap() {
      mapkit.init({
        authorizationCallback: function (done) {
          done('{{ mapkit_js_token }}');
        },
      });

      var map = new mapkit.Map('map-container', {
        center: new mapkit.Coordinate(51.320219, -0.138661), // Center on Coulsdon
        region: new mapkit.CoordinateRegion(
          new mapkit.Coordinate(51.320219, -0.138661),
          new mapkit.CoordinateSpan(0.02, 0.02) // Adjust the zoom level
        ),
        showsCompass: mapkit.FeatureVisibility.Hidden,
        showsZoomControl: true,
        tintColor: "{{ map_tint_color }}", // Use the selected tint color from theme settings
        colorScheme: mapkit.Map.ColorSchemes.{{ color_scheme | downcase }}, // Apply the selected color scheme
        pointOfInterestFilter: mapkit.PointOfInterestFilter.including([{{ poi_filter }}]), // Use the including method
        showsUserLocation: true, // Show the user's current location on the map
        tracksUserLocation: true, // Track the user's location as they move
        cameraBoundary: new mapkit.CameraBoundary( // Set the camera boundary
          new mapkit.CoordinateRegion(
            new mapkit.Coordinate(51.320219, -0.138661), // Center of the boundary
            new mapkit.CoordinateSpan(0.05, 0.05) // Span defining the boundary size
          )
        )
      });

      // Debugging line to check the value of locations
      console.log('Metaobjects locations:', {{ finial_definition | json }});

      // Manually construct the locations array in JavaScript
      var locations = [
        {% for location in finial_definition %}
        {
          "latitude": {{ location.latitude.value }},
          "longitude": {{ location.longitude.value }},
          "title": "{{ location.title.value }}",
          "description": "{{ location.description.value }}"
        }{% if forloop.last == false %},{% endif %}
        {% endfor %}
      ];

      console.log('Locations array:', locations); // Debugging line

      if (locations.length > 0) {
        // Adding annotations to the map using mapkit.Annotation
        var annotations = locations.map(function (location) {
          return new mapkit.Annotation(
            new mapkit.Coordinate(location.latitude, location.longitude),
            function () {
              // Create a DOM element for the annotation
              var element = document.createElement('div');
              element.className = 'mapkit-annotation';
              element.innerHTML = '<strong>' + location.title + '</strong><br>' + location.description;
              return element;
            },
            {
              title: location.title,
              subtitle: location.description,
              animates: true, // Set to false if you don't want the annotation to animate when added
              collisionMode: mapkit.Annotation.CollisionMode.Circle, // Use Circle for collision detection
              // Additional options for customizing the annotation
              callout: {
                title: location.title,
                subtitle: location.description,
              },
              selected: false, // Set to true if you want the annotation to be selected by default
              draggable: false, // Set to true if you want the annotation to be draggable
              enabled: true, // Set to false if you want to disable interaction with the annotation
              data: {
                customProperty: "customValue" // Any additional custom data you want to store with the annotation
              }
            }
          );
        });

        // Debugging line to check annotations
        console.log('Annotations array:', annotations);

        // Batch adding annotations to the map
        requestAnimationFrame(function () {
          map.addAnnotations(annotations);
        });
        // Enable clustering
        map.annotationsForCluster = function (annotations) {
          return annotations.length > 1; // Enable clustering when there are more than one annotation in the same area
        };
      } else {
        console.log('No locations available to display on the map.');
      }
    }

    document.addEventListener(
      'DOMContentLoaded',
      function () {
        if (typeof mapkit !== 'undefined') {
          initializeMap();
        } else {
          document
            .querySelector('script[src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js"]')
            .addEventListener('load', initializeMap, { passive: true });
        }
      },
      { passive: true }
    );
  </script>
</div>

<style>
  #map-container {
    /* Custom styles can be added here */
  }
</style>

{% schema %}
{
  "name": "Art Trail",
  "settings": [
    {
      "type": "color",
      "id": "map_tint_color",
      "label": "Map Tint Color",
      "default": "#9E185D",
      "info": "Select the tint color for the map elements."
    },
    {
      "type": "text",
      "id": "mapkit_js_token",
      "label": "MapKit JS Token",
      "default": "YOUR_MAPKIT_JS_TOKEN_HERE",
      "info": "Enter your MapKit JS token. You can get it from your Apple Developer account."
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "Hybrid",
      "options": [
        {
          "value": "Light",
          "label": "Light"
        },
        {
          "value": "Dark",
          "label": "Dark"
        },
        {
          "value": "Hybrid",
          "label": "Hybrid"
        }
      ]
    },
    {
      "type": "checkbox",
      "id": "poi_filter_parks",
      "label": "Show Parks",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "poi_filter_restaurants",
      "label": "Show Restaurants",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Art Trail",
      "category": "Art Trail"
    }
  ]
}
{% endschema %}
