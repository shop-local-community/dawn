{% comment %}
  Coulsdon Art Trail Interactive Map Section using Apple Maps with MapKit JS
  Dynamically pulling locations from Metaobjects
{% endcomment %}

{% assign locations = shop.metaobjects.art_trail_location %}
{% assign mapkit_js_token = section.settings.mapkit_js_token %}

<script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js" async></script>

<div class="coulsdon-art-trail">
  <div id="map-container" style="width: 100%; height: 480px;"></div>

  <script type="text/javascript">
    mapkit.init({
      authorizationCallback: function(done) {
        done("{{ mapkit_js_token }}"); // Use the mapkit_js_token variable here
      }
    });

    var map = new mapkit.Map("map-container", {
      center: new mapkit.Coordinate(51.320219, -0.138661), // Center on Coulsdon
      span: new mapkit.CoordinateSpan(0.02, 0.02), // Adjust the zoom level
      showsCompass: mapkit.FeatureVisibility.Hidden,
      showsZoomControl: true
    });

    // Fetching locations from Metaobjects
    var locations = [
      {% for location in locations %}
        {
          title: "{{ location.fields.title.value }}",
          latitude: {{ location.fields.latitude.value }},
          longitude: {{ location.fields.longitude.value }},
          description: "{{ location.fields.description.value }}"
        }{% if forloop.last == false %},{% endif %}
      {% endfor %}
    ];

    // Adding markers to the map
    locations.forEach(function(location) {
      var annotation = new mapkit.MarkerAnnotation(
        new mapkit.Coordinate(location.latitude, location.longitude),
        { title: location.title, subtitle: location.description }
      );
      map.addAnnotation(annotation);
    });
  </script>
</div>

<style>
  #map-container {
    /* border: 1px solid #ccc;
    margin: 20px 0; */
  }
</style>

{% schema %}
{
  "name": "Art Trail",
  "settings": [
    {
      "type": "text",
      "id": "mapkit_js_token",
      "label": "MapKit JS Token",
      "default": "eyJraWQiOiJEQUdYVDQ0SFNHIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiIzNFdVS1FCWFhIIiwiaWF0IjoxNzIzNDE0MzU0LCJvcmlnaW4iOiIqLmNvdWxzZG9ucGFydG5lcnNoaXAub3JnIiwiZXhwIjoxNzQ1NjIyMDAwfQ.gBNFjn13WASm2FZjrWz-h0FAPFUHZa0OXGLQkq0VryQ2eYSmCvIUpcqATHZ3HsgDWnjzrUcfmvvCOQfqQPYQiA",
      "info": "Enter your MapKit JS token. You can get it from your Apple Developer account."
    }
  ],
  "presets": [
    {
      "name": "Art Trail",
      "category": "Art Trail"
    }
  ]
}
{% endschema %}
